name: Ephemeral Issue

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: "integration"
        type: choice
        options:
        - integration
        - certification
      branch:
        required: true
        type: string

jobs:
  tree:
    name: Tree
    runs-on: ubuntu-latest
    permissions: write-all
    outputs:
      tree: ${{ steps.tree.outputs.tree }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run Script
        id: tree
        run: |
          chmod +x ${{ github.workspace}}/ee.sh
          
          TREE_JSON=$(bash ${{ github.workspace }}/ee.sh)

          # normalizar a una sola lÃ­nea (por seguridad)
          TREE_JSON=$(echo "$TREE_JSON" | jq -c .)

          echo "tree=$TREE_JSON" >> "$GITHUB_OUTPUT"
  
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          
  issue:
    name: Issue
    runs-on: ubuntu-latest
    needs: tree
    permissions: write-all
    steps:
      - name: Create Issue
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d "$(jq -n \
              --arg title "[EE] ${{ github.event.repository.name }}" \
              --arg repo "${{ github.event.repository.name }}" \
              --arg ref "${{ inputs.branch }}" \
              --arg tree '${{ needs.tree.outputs.tree }}' \
              --arg actor "${{ github.actor }}" \
              --arg env "${{ inputs.environment }}" '
              {
                title: $title,
                
                body: (
                  "## Ephemeral Environment Deployment\n\n" +
                  "### Context\n" +
                  "This issue was automatically generated to deploy an ephemeral environment.\n\n" +
          
                  "### Root Service\n" +
                  "- **Repository:** " + $repo + "\n" +
                  "- **ref:** "+$ref + "\n" +
                  "- **Triggered by:** @" + $actor + "\n" +
                  "- **Environment:** " + $env + "\n\n" +
          
                  "---\n\n" +
          
                  "### Dependency Graph\n" +
                  "```json\n" +
                  $tree +
                  "\n```"
                ),
                assignees: [$actor],
                labels: ["ephemeral", "main", $env]
              }'
            )"   


#  tree:
#    name: Tree
#    runs-on: ubuntu-latest
#    permissions: write-all
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v6
#      - name: Run Script
#        run: |
#          chmod +x ${{ github.workspace}}/ee.sh
#          bash ${{ github.workspace}}/ee.sh
#        shell: bash
#        env:
#          GITHUB_TOKEN: ${{ github.token }}#  issue:
#    name: Issue
#    runs-on: ubuntu-latest
#    permissions: write-all
#    steps:
#      - name: Create Issue
#        run: |
#          curl -L \
#            -X POST \
#            -H "Accept: application/vnd.github+json" \
#            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
#            -H "X-GitHub-Api-Version: 2022-11-28" \
#            https://api.github.com/repos/${{ github.repository }}/issues \
#            -d '{"title":"[EE] ${{ github.event.repository.name }}","body":"#### Deploy Ephemeral Environments: \nrepo:${{ github.event.repository.name }} \nref:${{ inputs.branch }}","assignees":["'"${{ github.actor }}"'"],"labels":["ephemeral", "main", "'"${{ inputs.environment }}"'"]}'
